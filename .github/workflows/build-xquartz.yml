name: Build XQuartz on macOS

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15
    timeout-minutes: 600

    steps:
      - name: Install cmake first (before checkout)
        timeout-minutes: 180
        run: |
          BUILD_TOOLS_PREFIX_CMAKE="/opt/buildX11-cmake"
          BASE_PATH="/usr/bin:/bin:/usr/sbin:/sbin"
          TMP_BASE=$(mktemp -d /tmp/macports-cmake-XXXXXX)
          trap "rm -rf ${TMP_BASE}" EXIT INT QUIT TERM
          
          bootstrap_base() {
            local PREFIX=$1
            if ! [ -f "${PREFIX}/bin/port" ]; then
              cd "${TMP_BASE}" || exit 1
              if ! [ -d "macports-base" ]; then
                git clone -b release-2.11 --depth 1 https://github.com/macports/macports-base.git || exit 1
              fi
              cd macports-base || exit 1
              ./configure --prefix="${PREFIX}" --with-applications-dir="${PREFIX}/Applications" --without-startupitems || exit 1
              make -j$(sysctl -n hw.activecpu) || exit 1
              sudo make install || exit 1
            fi
          }
          
          echo "Step 1: Bootstrapping MacPorts in CMAKE prefix..."
          bootstrap_base "${BUILD_TOOLS_PREFIX_CMAKE}"
          
          echo "Step 2: Installing cmake..."
          export PATH="${BUILD_TOOLS_PREFIX_CMAKE}/bin:${BASE_PATH}"
          sudo ${BUILD_TOOLS_PREFIX_CMAKE}/bin/port -v selfupdate || exit 1
          sudo ${BUILD_TOOLS_PREFIX_CMAKE}/bin/port -N -v -f install cmake || exit 1
          sudo ${BUILD_TOOLS_PREFIX_CMAKE}/bin/port deactivate rleaves || true
          
          echo "Step 3: Verifying cmake installation..."
          if [ -f "/opt/buildX11-cmake/bin/cmake" ] && [ -x "/opt/buildX11-cmake/bin/cmake" ]; then
            CMAKE_VERSION=$(/opt/buildX11-cmake/bin/cmake --version | head -1)
            echo "✓ cmake installed successfully: ${CMAKE_VERSION}"
            /opt/buildX11-cmake/bin/cmake --version | head -3
          else
            echo "✗ cmake installation verification failed"
            exit 1
          fi

      - name: Configure git URL rewrite for nested submodules
        run: |
          git config --global url."https://gitlab.freedesktop.org/xorg/util/xcb-util-m4.git".insteadOf "git://anongit.freedesktop.org/xcb/util-common-m4.git"

      - name: Checkout repository (code only)
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Checkout submodules
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive --force || true
          
          for libdir in src/xorg/lib/libxcb-*; do
            if [ -d "$libdir" ] && [ -f "$libdir/.gitmodules" ]; then
              cd "$libdir" || continue
              if grep -q "git://anongit.freedesktop.org/xcb/util-common-m4" .gitmodules 2>/dev/null; then
                sed -i.bak 's|git://anongit.freedesktop.org/xcb/util-common-m4|https://gitlab.freedesktop.org/xorg/util/xcb-util-m4|g' .gitmodules || \
                sed -i '' 's|git://anongit.freedesktop.org/xcb/util-common-m4|https://gitlab.freedesktop.org/xorg/util/xcb-util-m4|g' .gitmodules
                rm -f .gitmodules.bak
                git submodule sync
                git submodule update --init --force m4 || true
              fi
              cd - > /dev/null || true
            fi
          done
          
          git submodule update --init --recursive --force

      - name: Set up Xcode
        run: |
          xcode-select --print-path
          xcodebuild -version

      - name: Verify system dependencies
        run: |
          which git || (echo "ERROR: git not found" && exit 1)
          which make || (echo "ERROR: make not found" && exit 1)
          which clang || (echo "ERROR: clang not found" && exit 1)
          sw_vers
          echo "✓ System dependencies verified"

      - name: Install MacPorts and build tools (STD)
        timeout-minutes: 240
        run: |
          bash install-or-update-macports.sh 2>&1 | tee /tmp/macports-install.log | grep -E "(Installing|Building|Completed|Error|Failed)" || true
          echo "MacPorts installation completed"

      - name: Build XQuartz
        timeout-minutes: 240
        env:
          CI: true
          SANITIZER_CONFIGS: ""
          LC_ALL: C
          LANG: C
        run: |
          echo "Starting XQuartz build..."
          export MAKE_OPTS="-j$(sysctl -n hw.activecpu)"
          
          bash compile.sh 2>&1 | tee /tmp/build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          echo ""
          echo "Build script exited with code: $BUILD_EXIT_CODE"
          echo ""
          echo "=== Build Summary ==="
          grep -E "(Building|Installing|do_|✓|✗)" /tmp/build.log | tail -30 || true
          
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "=== Build failed. Error context (last 100 lines) ==="
            tail -100 /tmp/build.log || true
            echo ""
          fi
          
          APP_PATH="products/XQuartz.dest/Applications/Utilities/XQuartz.app"
          MACOS_DIR="${APP_PATH}/Contents/MacOS"
          
          echo ""
          echo "=== Verifying Build Artifacts ==="
          
          if [ ! -d "products" ]; then
            echo "✗ Build artifacts directory 'products/' not found"
            exit $BUILD_EXIT_CODE
          fi
          
          if [ ! -d "products/XQuartz.dest" ]; then
            echo "✗ Build staging directory 'products/XQuartz.dest' not found"
            exit $BUILD_EXIT_CODE
          fi
          
          if [ ! -d "${APP_PATH}" ]; then
            echo "✗ XQuartz.app bundle not found"
            exit 1
          fi
          
          MISSING_FILES=0
          if [ ! -f "${MACOS_DIR}/X11" ]; then
            echo "✗ CRITICAL: X11 server executable not found"
            MISSING_FILES=1
          fi
          if [ ! -f "${MACOS_DIR}/X11.bin" ]; then
            echo "✗ CRITICAL: X11.bin wrapper not found"
            MISSING_FILES=1
          fi
          if [ ! -f "${MACOS_DIR}/X11.sh" ]; then
            echo "✗ CRITICAL: X11.sh script not found"
            MISSING_FILES=1
          fi
          
          if [ $MISSING_FILES -eq 1 ]; then
            echo "✗ Build incomplete: Critical X11 executables are missing"
            exit 1
          fi
          
          echo "✓ All critical build artifacts verified"
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "Note: Script exited with error code $BUILD_EXIT_CODE, but core artifacts exist."
            exit 0
          fi

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xquartz-build-products
          path: |
            products/
            XQuartz-*.pkg
            XQuartz-*.dSYMS.tar.bz2
          retention-days: 7

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            *.log
            **/*.log
          retention-days: 7
